<!DOCTYPE html>

<html>
<head>
  <title>Mastermind JS</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>Mastermind Javascript</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="comment">/**************
Variables
***************/</span>
<span class="keyword">var</span> secret,
    guess,
    mark,
    game,
    form,
    win = <span class="string">'+++++'</span>,
    counter = <span class="number">0</span>;

<span class="comment">/**************
Document Ready:
  Click handlers
***************/</span>
$(<span class="keyword">function</span>() {</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>ensure the form does not propagate</p>

            </div>

            <div class="content"><div class='highlight'><pre>  form = $(<span class="string">'form'</span>);
  form.on(<span class="string">'click'</span>, <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="literal">false</span>;
  });

  <span class="comment">/**************
  Form Validation
  ***************/</span>
  form.validate({
    rules: {
      guess_text: {
        maxlength: <span class="number">5</span>,
        minlength: <span class="number">5</span>
      }
    },
    highlight: <span class="keyword">function</span>(element) {
      $(element).closest(<span class="string">'.control-group'</span>).removeClass(<span class="string">'success'</span>).addClass(<span class="string">'error'</span>);
    },
    success: <span class="keyword">function</span>(element) {
      element
      .text(<span class="string">'OK!'</span>).addClass(<span class="string">'valid'</span>)
      .closest(<span class="string">'.control-group'</span>).removeClass(<span class="string">'error'</span>).addClass(<span class="string">'success'</span>);
    }
  });

  <span class="comment">/**************
  Prep the game board
  ***************/</span>
  $(<span class="string">'.btn-primary'</span>).bind(<span class="string">'click'</span>, <span class="keyword">function</span>() {
    game = <span class="keyword">new</span> Game();
    prep_game_board();
  });

  <span class="comment">/**************
  Send guess for processing onClick and increment guess counter
  ***************/</span>
  $(<span class="string">'#guess'</span>).bind(<span class="string">'click'</span>, <span class="keyword">function</span>() {
    <span class="keyword">var</span> user_guess = $(<span class="string">'#guess_text'</span>).val();
    $(<span class="string">'#guess_text'</span>).val(<span class="string">""</span>);
    counter += <span class="number">1</span>;
    game.guess(user_guess);
  });

  <span class="comment">/**************
  High score handling onClick: create entry and redirect
  ***************/</span>
  $(<span class="string">'#submit_score'</span>).bind(<span class="string">'click'</span>, <span class="keyword">function</span>() {</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>submit the name for high score</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> name = $(<span class="string">'#highscore_name'</span>).val();
    <span class="keyword">var</span> high_score_url = <span class="string">"http://"</span> + window.location.host + <span class="string">"/highscore/"</span> + name;
    <span class="keyword">var</span> visit_high_scores = <span class="string">"http://"</span> + window.location.host + <span class="string">"/highscores"</span>;

    <span class="comment">/**************
    Post high score
    ***************/</span>
    <span class="keyword">var</span> high_score = $.ajax({
      type: <span class="string">"POST"</span>,
      url: high_score_url,
      accepts: <span class="string">"application/json"</span>,
      dataType: <span class="string">"json"</span>,
      data: {
        <span class="string">'game'</span>  : <span class="string">"mastermind"</span>,
        <span class="string">'score'</span> : counter },
      complete: <span class="keyword">function</span>(data){
        window.location.href = visit_high_scores;
      }
    });

    $(<span class="string">'#high_score_form'</span>).trigger(<span class="string">'close'</span>);
  });
});

<span class="comment">/**************
Prep game board
***************/</span>
<span class="keyword">var</span> prep_game_board = <span class="function"><span class="keyword">function</span> <span class="title">prep_game_board</span><span class="params">()</span> {</span></pre></div></div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>hide the header</p>

            </div>

            <div class="content"><div class='highlight'><pre>  $(<span class="string">'.hero-unit'</span>).slideUp(<span class="number">500</span>);
  $(<span class="string">'.guess_additions'</span>).remove();
  $(<span class="string">'.game_outline'</span>).show();
  $(<span class="string">'#highscore_name'</span>).val(<span class="string">""</span>);
  counter = <span class="number">0</span>;

  <span class="comment">/**************
  Debugging
  ***************/</span>
  console.log(game.secret);
};

<span class="comment">/**************
Game Class definition
***************/</span>
<span class="function"><span class="keyword">function</span> <span class="title">Game</span><span class="params">(start_code)</span> {</span>
  <span class="keyword">if</span>(<span class="keyword">typeof</span> start_code === <span class="string">'undefined'</span>) {
    <span class="keyword">this</span>.secret = codeGen();
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.secret = start_code;
  }
  <span class="keyword">this</span>.guess = <span class="function"><span class="keyword">function</span> <span class="title">guess</span><span class="params">(guess_string)</span>{</span>
    <span class="keyword">if</span>(guess_string.length &gt; <span class="number">5</span> || guess_string.length &lt; <span class="number">5</span>){
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Not a valid guess"</span>);
    }
    mark(<span class="keyword">this</span>.secret, guess_string);
  };
}

<span class="comment">/**************
Generate the secret code
***************/</span>
<span class="keyword">var</span> codeGen = <span class="function"><span class="keyword">function</span> <span class="title">codeGen</span><span class="params">()</span> {</span>
  <span class="keyword">return</span> (<span class="string">""</span>+Math.random()).substring(<span class="number">2</span>,<span class="number">7</span>);
};

<span class="comment">/**************
Send code and guess for validation
***************/</span>
<span class="keyword">var</span> mark = <span class="function"><span class="keyword">function</span> <span class="title">mark</span><span class="params">(secret_code, guess_string)</span>{</span>
  <span class="keyword">var</span> the_url = <span class="string">"http://"</span> + window.location.host + <span class="string">"/mastermind/game/"</span> + guess_string;
  <span class="keyword">var</span> mark_string = $.ajax({
    type: <span class="string">"POST"</span>,
    url: the_url,

    accepts: <span class="string">"application/json"</span>,
    dataType: <span class="string">"json"</span>,

    data: { <span class="string">'code'</span> : secret_code },
    complete: <span class="keyword">function</span>(data){
      <span class="keyword">var</span> output_mark = data[<span class="string">'responseText'</span>];
      process_output(secret_code, guess_string, output_mark);
    }
  });
};

<span class="comment">/**************
Build the guess display
Check for win
***************/</span>
<span class="keyword">var</span> process_output = <span class="function"><span class="keyword">function</span> <span class="title">process_output</span><span class="params">(secret, guess, output)</span> {</span>
  build_guess_html(guess, output);

  <span class="keyword">if</span> (output == win){
    form.hide();
    build_alert_html(<span class="string">"success"</span>);</pre></div></div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>change the score display</p>

            </div>

            <div class="content"><div class='highlight'><pre>    $(<span class="string">'#score_title'</span>).text(<span class="string">"You won in "</span> + counter + <span class="string">" moves"</span>);</pre></div></div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>make the lighbox visible</p>

            </div>

            <div class="content"><div class='highlight'><pre>    $(<span class="string">'#high_score_form'</span>).lightbox_me({
      centered: <span class="literal">true</span>,
      onLoad: <span class="keyword">function</span>() {
        $(<span class="string">'#high_score_form'</span>).find(<span class="string">'input:first'</span>).focus();
        }
      });
    e.preventDefault();
  }
};

<span class="comment">/**************
Builds the guess html
***************/</span>
<span class="keyword">var</span> build_guess_html = <span class="keyword">function</span>(input_string, output_string) {
  html = <span class="string">''</span>;
  html += <span class="string">"&lt;div class='row guess_additions'&gt;&lt;div class='span6 guess'&gt;&lt;p&gt;"</span>;
  html += input_string;
  html += <span class="string">"&lt;/p&gt;&lt;/div&gt;&lt;div class='span6 mark'&gt;&lt;p&gt;"</span>;
  html += output_string;
  html += <span class="string">"&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;"</span>;

  $(html).prependTo(<span class="string">'.guess_row'</span>);
};

<span class="comment">/**************
Builds alert html
***************/</span>
<span class="keyword">var</span> build_alert_html = <span class="keyword">function</span>(alert_type) {
  <span class="keyword">var</span> success_string = <span class="string">"&lt;div class='span6 offset2 guess_additions alert alert-"</span> + alert_type + <span class="string">"'&gt;&lt;p&gt;You guessed the secret!&lt;/p&gt;&lt;/div&gt;"</span>;
  $(success_string).prependTo(<span class="string">'.game_area'</span>);
};</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
